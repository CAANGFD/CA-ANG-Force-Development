<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA ANG Force Development Hub</title>
    
    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Core -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* THEME: CA ANG COMMAND PREMIERE */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS & ASSETS ---
        const ADMIN_PASSWORD = "change-me-1234"; 
        const firebaseAppId = typeof __app_id !== 'undefined' ? __app_id : 'ca-ang-force-dev';

        const IMAGES = {
            logo: "caang.png",
            unit129: "129.svg",
            unit144: "144.svg",
            unit146: "146.svg",
            unit163: "163.svg",
            unit195: "195.svg",
            commander: "butow.jpg",
            chief: "zweben.jpg",
            blueBook: "bluebook.jpg",
            brownBook: "brownbook.jpg",
            blueprint: "blueprint.jpg"
        };

        const UNITS = [
            { name: '129th RQW', link: 'https://www.129rqw.ang.af.mil/', img: IMAGES.unit129 },
            { name: '144th FW', link: 'https://www.144fw.ang.af.mil/', img: IMAGES.unit144 },
            { name: '146th AW', link: 'https://www.146aw.ang.af.mil/', img: IMAGES.unit146 },
            { name: '163rd ATKW', link: 'https://www.163atkw.ang.af.mil/', img: IMAGES.unit163 },
            { name: '195th WG', link: 'https://www.195wg.ang.af.mil/', img: IMAGES.unit195 },
        ];

        const LEADERSHIP = [
            { name: 'Major General Steven J. Butow', title: 'Commander', org: 'California Air National Guard', img: IMAGES.commander },
            { name: 'Chief Master Sergeant Seth M. Zweben', title: 'State Command Chief', org: 'California Air National Guard', img: IMAGES.chief }
        ];

        // --- COMPREHENSIVE DATA ---
        const CFDC_SEED = {
            '300': {
                id: '300', title: 'CFDC 300', subtitle: 'Foundational Development', target: 'AB - SSgt & 2Lt - Capt', timeline: '3-Day Seminar', enrollmentLink: '#',
                overview: 'Focuses on the transition from technician to professional Airman. Emphasis on CA ANG heritage, the dual-mission environment, and interpersonal communication.',
                objectives: [
                    'Analyze the Airman’s Creed and Oath in a California context.',
                    'Examine CA ANG heritage and Wing lineages.',
                    'Develop Emotional Intelligence for team integration.',
                    'Master professional military writing and briefing basics.',
                    'Differentiate between Title 32 and Title 10 mission sets.'
                ]
            },
            '500': {
                id: '500', title: 'CFDC 500', subtitle: 'Operational Leadership', target: 'TSgt - MSgt & Major', timeline: '4-Day Workshop', enrollmentLink: '#',
                overview: 'Bridges tactical execution and organizational leadership. Focuses on unit administration, team performance, and personnel management.',
                objectives: [
                    'Master the ACA cycle and professional feedback.',
                    'Execute unit-level personnel actions and resource programming.',
                    'Apply team dynamics to mission problem sets.',
                    'Navigate unit admin: EPRs, OPRs, and Award writing.',
                    'Apply UCMJ authority and administrative discipline.'
                ]
            },
            '700': {
                id: '700', title: 'CFDC 700', subtitle: 'Strategic Broadening', target: 'SMSgt - CMSgt & Lt Col - Col', timeline: '5-Day Course', enrollmentLink: '#',
                overview: 'Focuses on strategic enterprise, legislative liaison, and GPC. Tools to manage organizational culture and align capabilities with national defense strategy.',
                objectives: [
                    'Understand the Legislative Liaison and State Budgeting process.',
                    'Integrate inter-agency partners for domestic response.',
                    'Synthesize Great Power Competition (GPC) concepts.',
                    'Manage strategic communication and shape unit culture.',
                    'Advise senior leadership on strategic manpower planning.'
                ]
            }
        };

        const BOOK_CONTENT = {
            blue: {
                title: "The Blue Book",
                subtitle: "The Profession of Arms (AFM 1-1)",
                sections: [
                    { title: "Chapter 1: The Airman's Identity", desc: "Heritage and calling.", subsections: [{ name: "The Oath", items: ["Defend Constitution", "Orders", "Commitment"], detail: "A lifelong promise to the nation's system of law." }] },
                    { title: "Chapter 2: The Profession of Arms", desc: "Specialized expertise.", subsections: [{ name: "Airmanship", items: ["Technical Mastery", "Ethical Lead"], detail: "Expertise in the air and space domains." }] },
                    { title: "Chapter 3: Core Values", desc: "Virtues of character.", subsections: [{ name: "Core Values", items: ["Integrity First", "Service Before Self", "Excellence"], detail: "The ethical framework for every decision." }] },
                    { title: "Chapter 4: Force Development", desc: "Continuous learning.", subsections: [{ name: "Qualities", items: ["Resilience", "Self-Awareness"], detail: "Deliberate development of personal character." }] },
                    { title: "Chapter 5: Professional Conduct", desc: "Standards and tradition.", subsections: [{ name: "Standards", items: ["Bearing", "Dress", "Customs"], detail: "Upholding the professional image of the force." }] }
                ]
            },
            brown: {
                title: "The Brown Book",
                subtitle: "Enlisted Force Structure (AFH 36-2618)",
                sections: [
                    { title: "Chapter 1: Leadership Levels", desc: "Framework of our force.", subsections: [{ name: "Levels", items: ["Tactical", "Operational", "Strategic"], detail: "Defining where and how members lead." }] },
                    { title: "Chapter 2: Enlisted Tiers", desc: "Detailed rank roles.", subsections: [{ name: "Tiers", items: ["Junior Enlisted", "NCO", "Senior NCO"], detail: "Specific expectations for every rank." }] },
                    { title: "Chapter 3: General Responsibilities", desc: "Universal requirements.", subsections: [{ name: "Readiness", items: ["Fitness", "Medical", "Skill"], detail: "Every member must be fit to fight." }] },
                    { title: "Chapter 4: Specific Positions", desc: "Key specialized roles.", subsections: [{ name: "Positions", items: ["First Sergeant", "Command Chief", "SEL"], detail: "Specialized leadership for unit welfare." }] },
                    { title: "Chapter 5: Development & Feedback", desc: "Progression cycle.", subsections: [{ name: "Cycles", items: ["ACA Feedback", "PME", "Roadmap"], detail: "Deliberate mentoring and tracking growth." }] }
                ]
            }
        };

        const ENLISTED_ROADMAP = [
            { id: 'amn', title: 'Airman Tier', ranks: 'AB - SrA', icon: 'Users', steps: ['BMT', 'Tech School', '5-Level Upgrade', 'ALS'], desc: 'Adaptation and proficiency.', focusAreas: [{ title: 'Technician', text: 'Mastering AFSC.', bullets: ['CDCs', 'Journeyman', 'Readiness'] }, { title: 'Ethos', text: 'Core Values.', bullets: ['The Oath', 'Bearing', 'Standards'] }] },
            { id: 'nco', title: 'NCO Tier', ranks: 'SSgt - TSgt', icon: 'Shield', steps: ['7-Level Upgrade', 'Supervisor Safety', 'NCOA', 'CCAF'], desc: 'Frontline leadership.', focusAreas: [{ title: 'Supervisor', text: 'Managing small teams.', bullets: ['ACA Feedback', 'Counseling', 'EPRs'] }, { title: 'Operations', text: 'Section leadership.', bullets: ['Risk Mgmt', 'Resources', 'Training'] }] },
            { id: 'snco', title: 'SNCO Tier', ranks: 'MSgt - CMSgt', icon: 'Award', steps: ['SNCOA', 'SEJPME', 'Leadership Seminar', 'Boards'], desc: 'Strategic management.', focusAreas: [{ title: 'Advisor', text: 'Advising command.', bullets: ['Climate', 'Policy', 'Force Design'] }, { title: 'Enterprise', text: 'Asset management.', bullets: ['Manpower', 'Budgeting', 'Planning'] }] }
        ];

        const OFFICER_ROADMAP = [
            { id: 'cgo', title: 'Company Grade', ranks: '2Lt - Capt', icon: 'Target', steps: ['OTS', 'Tech School', 'SOS'], desc: 'Tactical competency.', focusAreas: [{ title: 'Flight Command', text: 'Managing flights.', bullets: ['Wellness', 'Admin Flow'] }] }
        ];

        // --- FIREBASE INITIALIZATION ---
        const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const firebaseConfig = rawFirebaseConfig ? JSON.parse(rawFirebaseConfig) : { apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: "" };

        let db = null;
        let auth = null;

        if (firebaseConfig.apiKey) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
        }

        // --- COMPONENTS ---

        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const iconKey = name.charAt(0).toUpperCase() + name.slice(1).replace(/-([a-z])/g, g => g[1].toUpperCase());
                    const iconData = window.lucide[iconKey] || window.lucide.HelpCircle;
                    if (iconData) {
                        const iconNode = window.lucide.createElement(iconData);
                        iconNode.setAttribute('width', size);
                        iconNode.setAttribute('height', size);
                        if (className) iconNode.setAttribute('class', className);
                        iconNode.setAttribute('stroke-width', 2);
                        containerRef.current.appendChild(iconNode);
                    }
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none"></span>;
        };

        const FocusAreaCard = ({ title, text, bullets }) => {
            const [flipped, setFlipped] = useState(false);
            return (
                <div className="group perspective-1000 h-64 w-full cursor-pointer" onClick={() => setFlipped(!flipped)}>
                    <div className={`relative h-full w-full transition-all duration-700 transform-style-3d ${flipped ? 'rotate-y-180' : ''}`}>
                        <div className="absolute inset-0 h-full w-full bg-white rounded-3xl shadow-xl border border-slate-100 p-6 flex flex-col items-center justify-center text-center backface-hidden z-20">
                            <div className="bg-blue-50 p-4 rounded-2xl mb-4 group-hover:scale-110 transition-transform"><Icon name="star" size={32} className="text-[#00308F]" /></div>
                            <h4 className="text-lg font-black text-slate-900 mb-2 leading-tight">{title}</h4>
                            <p className="text-xs text-slate-500 leading-relaxed px-4">{text}</p>
                        </div>
                        <div className="absolute inset-0 h-full w-full bg-[#00308F] rounded-3xl shadow-lg p-6 flex flex-col backface-hidden rotate-y-180 text-white overflow-hidden z-10 text-left">
                            <h4 className="text-sm font-black mb-4 border-b border-blue-400/50 pb-2 uppercase tracking-widest leading-none">{title}</h4>
                            <ul className="text-[10px] space-y-2.5 overflow-y-auto custom-scroll pr-2">
                                {bullets && bullets.map((b, i) => (<li key={i} className="flex items-start"><Icon name="check-circle" size={10} className="mr-2 mt-0.5 text-blue-300 flex-shrink-0" /><span className="font-medium leading-tight">{b}</span></li>))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        const BookViewer = ({ book, onBack }) => {
            const isBrown = book.title.toLowerCase().includes('brown');
            const colorClass = isBrown ? 'bg-[#5D4037]' : 'bg-[#00308F]';
            return (
                <div className="animate-enter space-y-12 pb-20">
                    <button onClick={onBack} className="flex items-center text-sm font-black text-slate-400 hover:text-[#00308F] uppercase tracking-widest transition-colors"><Icon name="arrow-left" size={16} className="mr-2" /> Back</button>
                    <div className={`${colorClass} rounded-[3rem] p-12 text-white shadow-2xl relative overflow-hidden`}>
                        <h3 className="text-5xl font-black text-white leading-none relative z-10">{book.title}</h3>
                        <p className="text-white/60 font-bold uppercase mt-3 tracking-widest text-sm relative z-10">{book.subtitle}</p>
                        <div className="absolute -right-20 -bottom-20 opacity-10 rotate-12"><Icon name="book" size={300} /></div>
                    </div>
                    <div className="grid lg:grid-cols-1 gap-12">
                        {book.sections.map((section, i) => (
                            <div key={i} className="bg-white border border-slate-100 p-10 rounded-[3rem] shadow-sm">
                                <h4 className="text-2xl font-black text-slate-900 uppercase tracking-tighter mb-4 leading-none">{section.title}</h4>
                                <p className="text-slate-500 font-bold mb-8 italic">"{section.desc}"</p>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                                    {section.subsections.map((sub, j) => (
                                        <div key={j} className="bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                                            <h5 className={`font-black uppercase text-xs tracking-widest mb-3 leading-none ${isBrown ? 'text-[#5D4037]' : 'text-[#00308F]'}`}>{sub.name}</h5>
                                            <p className="text-[10px] text-slate-400 font-bold mb-4 leading-relaxed uppercase">{sub.detail}</p>
                                            <div className="space-y-2">
                                                {sub.items.map((item, k) => (<div key={k} className="flex items-center text-[10px] font-black text-slate-700 uppercase tracking-wider leading-tight"><div className={`w-1 h-1 rounded-full mr-2 ${isBrown ? 'bg-orange-300' : 'bg-blue-300'}`}></div>{item}</div>))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const CFDCView = ({ courses }) => {
            const [selectedId, setSelectedId] = useState(null);
            if (selectedId && courses[selectedId]) {
                const course = courses[selectedId];
                return (
                    <div className="animate-enter space-y-8">
                        <button onClick={() => setSelectedId(null)} className="flex items-center text-sm font-black text-slate-400 uppercase tracking-widest"><Icon name="arrow-left" size={16} className="mr-2" /> Catalog</button>
                        <div className="bg-[#00308F] rounded-[3rem] p-12 text-white shadow-2xl relative overflow-hidden"><h3 className="text-5xl font-black text-white relative z-10 leading-none">{course.title}</h3><p className="text-blue-200 font-bold uppercase mt-3 tracking-widest text-sm relative z-10">{course.subtitle}</p><a href={course.enrollmentLink} target="_blank" className="mt-12 inline-block bg-white text-[#00308F] px-12 py-5 rounded-2xl font-black uppercase text-xs shadow-xl hover:scale-105 transition-all relative z-10 tracking-widest">Enrollment Portal</a><div className="absolute -right-20 -bottom-20 opacity-5"><Icon name="shield" size={300} /></div></div>
                        <div className="grid md:grid-cols-2 gap-12 mt-12"><div className="space-y-6"><h4 className="font-black text-slate-900 uppercase text-xs tracking-widest border-b pb-2">Learning Objectives</h4>{(course.objectives || []).map((obj, i) => (<div key={i} className="flex items-start bg-white p-5 rounded-3xl border border-slate-100 shadow-sm font-bold text-slate-700"><Icon name="check-circle" className="text-green-500 mr-4 flex-shrink-0" size={18} />{obj}</div>))}</div><div className="bg-slate-50 p-10 rounded-[3rem] space-y-6"><h4 className="font-black text-slate-900 uppercase text-xs tracking-widest border-b border-slate-200 pb-2">Overview</h4><p className="text-slate-600 leading-relaxed font-medium">{course.overview}</p></div></div>
                    </div>
                );
            }
            return (
                <div className="animate-enter space-y-16">
                    <h2 className="text-4xl font-black text-slate-900 tracking-tighter uppercase text-center">Course Catalog</h2>
                    <div className="grid md:grid-cols-3 gap-8">
                        {['300', '500', '700'].map(id => (
                            <div key={id} onClick={() => setSelectedId(id)} className="bg-white border border-slate-100 rounded-[3rem] p-10 hover:shadow-2xl transition-all cursor-pointer group relative overflow-hidden flex flex-col min-h-[380px]">
                                <div className="text-7xl font-black text-slate-50 absolute -right-2 -top-2 select-none">#{id}</div>
                                <div className="relative z-10"><h4 className="text-3xl font-black text-slate-900 group-hover:text-[#00308F] transition-colors">{courses[id]?.title || `CFDC ${id}`}</h4><p className="text-[10px] font-black text-[#00308F] uppercase mt-2 tracking-widest">{courses[id]?.subtitle}</p><p className="text-sm text-slate-500 mt-8 leading-relaxed line-clamp-4 font-medium">{courses[id]?.overview}</p></div>
                                <div className="mt-auto pt-8 flex items-center text-[10px] font-black text-slate-300 uppercase tracking-widest group-hover:text-[#00308F]">Details <Icon name="chevron-right" size={14} className="ml-2" /></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HomeView = ({ onTabChange, onCategorySelect }) => (
            <div className="space-y-16 animate-enter">
                <div className="relative overflow-hidden rounded-[3.5rem] bg-gradient-to-br from-[#00308F] to-[#0B1F3F] p-12 md:p-20 text-white shadow-2xl text-center">
                    <div className="relative z-10 max-w-4xl mx-auto">
                        <div className="inline-flex items-center bg-white/10 backdrop-blur-md border border-white/20 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] mb-8"><Icon name="shield" size={14} className="mr-2 text-blue-300"/> Force Development Hub</div>
                        <h2 className="text-5xl md:text-8xl font-black mb-10 tracking-tighter uppercase text-white drop-shadow-sm leading-none">FORCE DEVELOPMENT HUB</h2>
                        <div className="flex flex-wrap justify-center gap-6">
                            <button onClick={() => onTabChange('enlisted')} className="bg-white text-[#00308F] px-12 py-5 rounded-2xl font-black shadow-xl hover:scale-105 active:scale-95 transition-all text-sm uppercase tracking-widest">ENLISTED TRACK</button>
                            <button onClick={() => onTabChange('cfdc')} className="bg-transparent border-2 border-white/50 text-white px-12 py-5 rounded-2xl font-black hover:bg-white/10 active:scale-95 transition-all text-sm uppercase tracking-widest">CFDC PROGRAMS</button>
                        </div>
                    </div>
                </div>
                <div className="grid lg:grid-cols-2 gap-8">
                    {LEADERSHIP.map((leader, i) => (
                        <div key={i} className="bg-white border border-slate-100 p-6 rounded-[2.5rem] flex items-center shadow-sm hover:shadow-lg transition-all">
                            <div className="w-24 h-24 rounded-[1.5rem] overflow-hidden mr-6 shadow-md border-4 border-slate-50 flex-shrink-0"><img src={leader.img} alt={leader.name} className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://via.placeholder.com/100'} /></div>
                            <div><h4 className="font-black text-slate-800 leading-tight tracking-tight">{leader.name}</h4><p className="text-[10px] font-black text-[#00308F] uppercase tracking-widest mt-1">{leader.title}</p><p className="text-[10px] text-slate-400 font-bold uppercase mt-0.5">{leader.org}</p></div>
                        </div>
                    ))}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                    {[{ label: 'Courses', icon: 'graduation-cap', tab: 'cfdc' }, { label: 'Library', icon: 'library', tab: 'resources' }, { label: 'ALQs', icon: 'target', cat: 'ALQs' }, { label: 'Strategic', icon: 'globe', tab: 'strategy' }].map((item, i) => (
                        <button key={i} onClick={() => item.tab ? onTabChange(item.tab) : onCategorySelect(item.cat)} className="flex flex-col items-center p-8 bg-white border border-slate-100 rounded-[2.5rem] shadow-sm hover:shadow-2xl transition-all group">
                            <div className="bg-slate-50 p-5 rounded-3xl mb-4 group-hover:bg-blue-50 transition-colors"><Icon name={item.icon} size={32} className="text-[#00308F]" /></div>
                            <span className="font-black text-slate-900 text-[10px] uppercase tracking-widest">{item.label}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [user, setUser] = useState(null);
            const [resources, setResources] = useState([]);
            const [courses, setCourses] = useState({});
            const [categoryFilter, setCategoryFilter] = useState('All');
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [mobileOpen, setMobileOpen] = useState(false);
            const [expandedTier, setExpandedTier] = useState(0);
            const [selectedBook, setSelectedBook] = useState(null);

            // Auth Logic (Rule 3)
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) await auth.signInWithCustomToken(token);
                        else await auth.signInAnonymously();
                        auth.onAuthStateChanged(setUser);
                    } catch (e) { console.error("Auth error", e); }
                };
                initAuth();
            }, []);

            // Data Hook (Rule 1 & 2)
            useEffect(() => {
                if (!user || !db) return;
                const unsubRes = db.collection('artifacts').doc(firebaseAppId).collection('public').doc('data').collection('resources').onSnapshot(snap => { const list = []; snap.forEach(d => list.push({ id: d.id, ...d.data() })); setResources(list); }, err => console.error(err));
                const unsubCourses = db.collection('artifacts').doc(firebaseAppId).collection('public').doc('data').collection('courses').onSnapshot(snap => {
                        const data = {}; snap.forEach(d => data[d.id] = d.data());
                        if (Object.keys(data).length === 0) { Object.keys(CFDC_SEED).forEach(id => db.collection('artifacts').doc(firebaseAppId).collection('public').doc('data').collection('courses').doc(id).set(CFDC_SEED[id])); } else { setCourses(data); }
                    }, err => console.error(err));
                return () => { unsubRes(); unsubCourses(); };
            }, [user]);

            const useProgressHook = (user) => {
                const [progress, setProgress] = useState({});
                useEffect(() => {
                    if (!user || !db) return;
                    const unsub = db.collection('artifacts').doc(firebaseAppId).collection('users').doc(user.uid).collection('progress').onSnapshot((snap) => {
                        const data = {}; snap.forEach(doc => { data[doc.id] = doc.data().completed; }); setProgress(data);
                    }, err => console.error(err));
                    return () => unsub();
                }, [user]);
                const toggleItem = async (id) => {
                    if (!user || !db) return;
                    await db.collection('artifacts').doc(firebaseAppId).collection('users').doc(user.uid).collection('progress').doc(id).set({ completed: !progress[id] }, { merge: true });
                };
                const getPercentage = (ids) => {
                    if (!ids || !ids.length) return 0;
                    const count = ids.filter(id => progress[id]).length;
                    return Math.round((count / ids.length) * 100);
                };
                return { progress, toggleItem, isComplete: (id) => !!progress[id], getPercentage };
            };

            const userProgress = useProgressHook(user);
            const navItems = [{ id: 'home', label: 'Hub' }, { id: 'enlisted', label: 'Enlisted' }, { id: 'officer', label: 'Officer' }, { id: 'cfdc', label: 'Courses' }, { id: 'resources', label: 'Library' }, { id: 'admin', label: 'Admin' }];

            const RoadmapView = ({ data, title, userProgress, books }) => {
                const { toggleItem, isComplete, getPercentage } = userProgress;
                if (selectedBook) return <BookViewer book={BOOK_CONTENT[selectedBook]} onBack={() => setSelectedBook(null)} />;

                return (
                    <div className="animate-enter space-y-12">
                        <h2 className="text-4xl font-black text-center text-slate-900 tracking-tighter uppercase border-b border-slate-100 pb-12 leading-none">{title}</h2>
                        {books && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                                {Object.entries({blue: IMAGES.blueBook, brown: IMAGES.brownBook, blueprint: IMAGES.blueprint}).map(([key, img]) => (
                                    <button key={key} onClick={() => setSelectedBook(key)} className="bg-white border border-slate-100 p-8 rounded-[3rem] flex flex-col items-center hover:shadow-2xl transition-all group">
                                        <div className="w-32 h-44 mb-6 rounded-md shadow-xl overflow-hidden group-hover:scale-105 transition-transform border border-slate-100"><img src={img} alt={key} className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://via.placeholder.com/128x176'} /></div>
                                        <h3 className="font-black text-slate-900 text-xs uppercase tracking-[0.2em]">The {key.charAt(0).toUpperCase() + key.slice(1)} Book</h3>
                                        <div className="mt-4 flex items-center text-[10px] font-black text-blue-400 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-all">Interactive View <Icon name="chevron-right" size={10} className="ml-1" /></div>
                                    </button>
                                ))}
                            </div>
                        )}
                        <div className="space-y-12 relative">
                            <div className="absolute left-10 top-0 bottom-0 w-1 bg-slate-200/50 rounded-full"></div>
                            {data.map((tier, i) => {
                                const isOpen = expandedTier === i;
                                const pct = getPercentage(tier.steps.map(s => `${tier.id}-${s}`));
                                return (
                                    <div key={i} className="relative pl-24">
                                        <div onClick={() => setExpandedTier(isOpen ? null : i)} className={`absolute left-0 top-0 w-20 h-20 rounded-[2rem] flex items-center justify-center shadow-2xl border-8 border-white z-10 cursor-pointer transition-all ${isOpen ? 'bg-[#00308F] text-white scale-110' : 'bg-slate-100 text-slate-400'}`}><Icon name={tier.icon} size={32} /></div>
                                        <div className={`rounded-[3rem] border bg-white transition-all overflow-hidden ${isOpen ? 'border-[#00308F] shadow-2xl' : 'border-slate-100 shadow-sm'}`}>
                                            <div onClick={() => setExpandedTier(isOpen ? null : i)} className="p-8 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors">
                                                <div><h4 className="text-2xl font-black text-slate-900 leading-tight tracking-tight">{tier.title}</h4><p className="text-[10px] font-black text-[#00308F] uppercase mt-1 tracking-widest">{tier.ranks}</p></div>
                                                <div className="text-right"><div className="text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 text-xs text-right">Progress</div><div className="font-black text-slate-900 text-xl leading-none">{pct}%</div></div>
                                            </div>
                                            {isOpen && (
                                                <div className="p-10 bg-slate-50/50 animate-enter border-t border-slate-100">
                                                    <div className="grid md:grid-cols-2 gap-10">
                                                        <div>
                                                            <h5 className="font-black text-slate-400 uppercase text-[10px] tracking-widest mb-6 text-left">Track Milestones</h5>
                                                            {tier.steps.map((step, j) => {
                                                                const id = `${tier.id}-${step}`; const done = isComplete(id);
                                                                return (
                                                                    <div key={j} onClick={() => toggleItem(id)} className={`flex items-center p-4 rounded-2xl border-2 mb-2 cursor-pointer transition-all ${done ? 'bg-green-50 border-green-200 shadow-none' : 'bg-white border-slate-100 shadow-sm hover:border-blue-200'}`}>
                                                                        <div className={`w-6 h-6 rounded-lg mr-4 flex items-center justify-center ${done ? 'bg-green-500 text-white' : 'bg-slate-100'}`}>{done && <Icon name="check" size={14}/>}</div>
                                                                        <span className={`font-bold text-sm ${done ? 'text-green-800' : 'text-slate-700'}`}>{step}</span>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                        <div className="grid gap-4 content-start">
                                                            <h5 className="font-black text-slate-400 uppercase text-[10px] tracking-widest mb-2 text-left">Development Focus</h5>
                                                            {tier.focusAreas.map((f, j) => (<FocusAreaCard key={j} title={f.title} text={f.text} bullets={f.bullets} />))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const AdminLogin = ({ onLogin }) => {
                const [pass, setPass] = useState('');
                const [error, setError] = useState(false);
                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (pass === ADMIN_PASSWORD) onLogin(); else setError(true);
                };
                return (
                    <div className="animate-enter max-w-md mx-auto py-20 px-4">
                        <div className="bg-white p-10 rounded-[3rem] shadow-2xl border border-slate-100 text-center"><div className="bg-slate-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-8"><Icon name="lock" size={32} className="text-[#00308F]" /></div><h3 className="text-2xl font-black text-slate-900 mb-6 uppercase tracking-tight text-[#00308F]">Admin Portal</h3><form onSubmit={handleSubmit} className="space-y-4"><input type="password" className={`w-full p-5 bg-slate-50 border rounded-2xl font-bold focus:ring-4 outline-none transition-all ${error ? 'border-red-500' : 'border-slate-100'}`} placeholder="Admin Key" value={pass} onChange={e => { setPass(e.target.value); setError(false); }} autoFocus /><button className="w-full bg-[#00308F] text-white py-5 rounded-2xl font-black uppercase text-xs shadow-xl tracking-widest">Authenticate</button></form></div>
                    </div>
                );
            };

            const ResourceView = ({ resources, categoryFilter, setCategoryFilter }) => {
                const [searchTerm, setSearchTerm] = useState('');
                const filtered = resources.filter(r => (r.title || "").toLowerCase().includes(searchTerm.toLowerCase()) && (categoryFilter === 'All' || r.category === categoryFilter));
                return (
                    <div className="animate-enter space-y-12">
                        <div className="flex flex-col md:flex-row justify-between border-b border-slate-100 pb-10 gap-8">
                            <h2 className="text-3xl font-black uppercase text-slate-900 leading-none tracking-tight">Library</h2>
                            <div className="relative"><Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" /><input type="text" placeholder="Search..." className="pl-12 pr-6 py-4 bg-white border border-slate-200 rounded-2xl outline-none font-bold text-sm shadow-sm focus:ring-2 focus:ring-blue-100 w-full md:w-80 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/></div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {['All', 'Regulations', 'ALQs', 'Reading', 'Videos'].map(cat => (<button key={cat} onClick={() => setCategoryFilter(cat)} className={`px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all ${categoryFilter === cat ? 'bg-[#00308F] text-white shadow-lg' : 'bg-white border text-slate-400'}`}>{cat}</button>))}
                        </div>
                        <div className="grid md:grid-cols-3 gap-8">
                            {filtered.map(res => (<div key={res.id} className="bg-white border border-slate-100 p-8 rounded-[2.5rem] shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all group flex flex-col h-full"><span className="bg-blue-50 text-[#00308F] px-4 py-1.5 rounded-full text-[10px] font-black uppercase mb-4 inline-block w-fit">{res.category}</span><h4 className="text-xl font-black text-slate-900 mb-4 tracking-tight leading-tight">{res.title}</h4><p className="text-xs text-slate-500 mb-6 leading-relaxed flex-grow">{res.description}</p><a href={res.link} target="_blank" className="flex items-center text-[10px] font-black text-slate-300 uppercase hover:text-[#00308F]">Open Asset <Icon name="external-link" size={12} className="ml-2" /></a></div>))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col min-h-screen selection:bg-[#00308F] selection:text-white bg-slate-50 font-sans">
                    <header className="glass-header border-b h-24 flex items-center sticky top-0 z-50 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 w-full flex justify-between items-center h-full">
                            <div className="flex items-center space-x-5 cursor-pointer group h-full" onClick={() => setActiveTab('home')}>
                                <div className="bg-[#00308F] p-3 rounded-2xl shadow-xl text-white transition-all group-hover:scale-110 overflow-hidden w-12 h-12 flex items-center justify-center"><img src={IMAGES.logo} alt="Logo" className="max-w-full max-h-full object-contain" onError={(e) => e.target.src = 'https://via.placeholder.com/48?text=Logo'} /></div>
                                <div className="flex flex-col"><h1 className="font-black text-2xl uppercase tracking-tighter text-slate-900 leading-none">CA ANG</h1><span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#00308F] mt-1 opacity-60">Force Development Hub</span></div>
                            </div>
                            <nav className="hidden lg:flex space-x-1">{navItems.map(item => (<button key={item.id} onClick={() => { setActiveTab(item.id); setCategoryFilter('All'); setMobileOpen(false); }} className={`px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-[0.15em] transition-all ${activeTab === item.id ? 'bg-[#00308F] text-white shadow-2xl translate-y-[-2px]' : 'text-slate-400 hover:text-slate-900 hover:bg-slate-100'}`}>{item.label}</button>))}</nav>
                            <button onClick={() => setMobileOpen(!mobileOpen)} className="lg:hidden p-3 text-slate-400"><Icon name={mobileOpen ? "x" : "menu"} size={28} /></button>
                        </div>
                        {mobileOpen && (<div className="lg:hidden absolute top-24 left-0 w-full bg-white border-b shadow-2xl animate-enter z-50 p-6 flex flex-col gap-2">{navItems.map(item => (<button key={item.id} onClick={() => { setActiveTab(item.id); setMobileOpen(false); }} className={`w-full text-left p-5 rounded-2xl font-black uppercase tracking-widest text-xs ${activeTab === item.id ? 'bg-[#00308F] text-white' : 'bg-slate-50 text-slate-400'}`}>{item.label}</button>))}</div>)}
                    </header>
                    <main className="flex-grow max-w-7xl mx-auto w-full p-4 md:p-12">
                        {activeTab === 'home' && <HomeView onTabChange={setActiveTab} onCategorySelect={(c) => { setCategoryFilter(c); setActiveTab('resources'); }} />}
                        {activeTab === 'enlisted' && (
                            <RoadmapView data={ENLISTED_ROADMAP} title="Enlisted Continuum" type="enlisted" userProgress={userProgress} books={true} />
                        )}
                        {activeTab === 'officer' && <RoadmapView data={OFFICER_ROADMAP} title="Officer Continuum" type="officer" userProgress={userProgress} />}
                        {activeTab === 'cfdc' && <CFDCView courses={courses} />}
                        {activeTab === 'resources' && <ResourceView resources={resources} categoryFilter={categoryFilter} setCategoryFilter={setCategoryFilter} />}
                        {activeTab === 'admin' && (isAdminAuth ? <div className="p-12 text-slate-400 italic text-center">Manage portal resources via direct Firebase access or console tools.</div> : <AdminLogin onLogin={() => setIsAdminAuth(true)} />)}
                    </main>
                    <footer className="bg-slate-900 text-slate-500 py-24 border-t-8 border-[#00308F]"><div className="max-w-7xl mx-auto px-4 text-center"><Icon name="shield" size={48} className="mx-auto mb-6 opacity-20" /><p className="text-[10px] font-black uppercase tracking-[0.5em] opacity-40">Integrity First • Service Before Self • Excellence In All We Do</p></div></footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
